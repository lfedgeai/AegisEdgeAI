# Quick Start Guide - Phase 1 Implementation

## Overview

This comprehensive guide covers building, testing, and using the Phase 1 Unified Identity feature in SPIRE. It includes step-by-step instructions for building, running unit tests, integration tests, and enabling the feature flag.

## Prerequisites

### Required Software

1. **Go 1.22.0 or later**
   ```bash
   go version
   # Should show: go version go1.22.0 or later
   ```

2. **Protocol Buffer Compiler (protoc)**
   ```bash
   protoc --version
   # Should show: libprotoc 3.12.4 or later
   ```

3. **Build Tools**
   ```bash
   which make unzip
   # Should show paths to both tools
   ```

### Install Missing Dependencies

**On Ubuntu/Debian:**
```bash
sudo apt-get update
sudo apt-get install -y unzip build-essential

# Install protoc if needed
PROTOC_VERSION=30.2
curl -LO "https://github.com/protocolbuffers/protobuf/releases/download/v${PROTOC_VERSION}/protoc-${PROTOC_VERSION}-linux-x86_64.zip"
unzip protoc-${PROTOC_VERSION}-linux-x86_64.zip -d /tmp/protoc
sudo mv /tmp/protoc/bin/protoc /usr/local/bin/
sudo mv /tmp/protoc/include/* /usr/local/include/
```

**On macOS:**
```bash
brew install protobuf unzip
```

## Step 1: Build Everything

### 1.1 Regenerate Protobuf Code

**Regenerate go-spiffe protobufs:**
```bash
cd hybrid-cloud-poc/code-rollout-phase-1/go-spiffe
make generate
```

Expected output:
```
compiling gRPC proto/spiffe/workload/workload.proto...
compiling proto proto/spiffe/workload/workload.proto...
```

**Regenerate spire-api-sdk protobufs:**
```bash
cd ../spire-api-sdk
make generate
```

Expected output:
```
compiling proto/spire/api/server/svid/v1/svid.proto...
compiling API proto/spire/api/server/svid/v1/svid.proto...
```

### 1.2 Build SPIRE Server and Agent

```bash
cd ../spire

# Build SPIRE Server
go build ./cmd/spire-server

# Build SPIRE Agent
go build ./cmd/spire-agent
```

### 1.3 Verify Build

```bash
# Check binaries were created
ls -lh spire-server spire-agent

# Verify they run
./spire-server --version
./spire-agent --version
```

Expected output:
```
1.14.0-dev-unk
```

## Step 2: Run Unit Tests

### 2.1 Test Keylime Client

```bash
cd hybrid-cloud-poc/code-rollout-phase-1/spire
go test ./pkg/server/sovereign/keylime/... -v
```

**Expected Results:**
- `TestNewClient` - PASS
- `TestVerifyEvidence_FeatureFlagDisabled` - PASS
- `TestVerifyEvidence_FeatureFlagEnabled` - PASS
- `TestVerifyEvidence_ValidationErrors` - PASS
- `TestBuildVerifyRequest` - PASS

### 2.2 Test Policy Engine

```bash
go test ./pkg/server/sovereign/... -v
```

**Expected Results:**
- `TestDefaultPolicyConfig` - PASS
- `TestEvaluatePolicy_FeatureFlagDisabled` - PASS
- `TestEvaluatePolicy_FeatureFlagEnabled` - PASS
- `TestEvaluatePolicy_NilClaims` - PASS
- `TestEvaluatePolicy_GPUUtilizationThreshold` - PASS
- `TestEvaluatePolicy_NoGPUMetrics` - PASS
- `TestEvaluatePolicy_MultipleGeolocations` - PASS

### 2.3 Test Agent Sovereign Handling

```bash
go test ./pkg/agent/endpoints/workload/... -run Sovereign -v
```

**Expected Results:**
- `TestGenerateStubbedSovereignAttestation_FeatureFlagDisabled` - PASS
- `TestGenerateStubbedSovereignAttestation_FeatureFlagEnabled` - PASS
- `TestValidateSovereignAttestation` - PASS
- `TestProcessSovereignAttestation` - PASS

### 2.4 Test Server SVID Service

```bash
go test ./pkg/server/api/svid/v1/... -run Sovereign -v
```

**Expected Results:**
- `TestBatchNewX509SVID_WithSovereignAttestation` - PASS
- `TestBatchNewX509SVID_FeatureFlagDisabled` - PASS

### 2.5 Run All Sovereign Tests (Comprehensive)

```bash
cd hybrid-cloud-poc/code-rollout-phase-1
./test_all_sovereign.sh
```

**Expected Output:**
```
==========================================
Sovereign Attestation Test Suite
==========================================
Testing Keylime Client... PASSED
Testing Policy Engine... PASSED
Testing Server SVID Service (Sovereign)... PASSED
Testing Agent Workload Handler... PASSED

==========================================
Test Summary
==========================================
Passed: 4
Failed: 0

All tests passed!
```

## Step 3: Run Integration Tests

### 3.1 Integration Test Setup

```bash
cd hybrid-cloud-poc/code-rollout-phase-1/spire/test/integration/suites/sovereign-attestation

# Make scripts executable
chmod +x 00-setup 01-test-sovereign-attestation teardown

# Run setup
./00-setup
```

This will:
- Build SPIRE Server and Agent binaries
- Place them in the test suite directory

### 3.2 Run Integration Test

```bash
./01-test-sovereign-attestation
```

**Expected Output:**
```
Running sovereign attestation integration test...
Sovereign attestation integration test passed
```

### 3.3 Cleanup Integration Test

```bash
./teardown
```

## Feature Flag

**Name**: `Unified-Identity`  
**Default**: Disabled (false)  
**Location**: `spire/pkg/common/fflag/fflag.go`

## Step 4: Enable Feature Flag

### 4.1 Create SPIRE Server Configuration

Create a `server.conf` file:

```hcl
server {
    bind_address = "127.0.0.1"
    bind_port = "8081"
    socket_path = "/tmp/spire-server/private/api.sock"
    trust_domain = "example.org"
    data_dir = "./.data/server"
    log_level = "INFO"
    log_file = "./spire-server.log"
    
    # Unified-Identity - Phase 1: Enable feature flag
    feature_flags = ["Unified-Identity"]
    
    ca_subject {
        country = ["US"]
        organization = ["SPIRE"]
        common_name = "SPIRE Server CA"
    }
}

plugins {
    DataStore "sql" {
        plugin_data {
            database_type = "sqlite3"
            connection_string = "./.data/server/datastore.sqlite3"
        }
    }
}
```

### 4.2 Create SPIRE Agent Configuration

Create an `agent.conf` file:

```hcl
agent {
    data_dir = "./.data/agent"
    log_level = "INFO"
    log_file = "./spire-agent.log"
    server_address = "127.0.0.1"
    server_port = "8081"
    socket_path = "/tmp/spire-agent/public/api.sock"
    
    # Unified-Identity - Phase 1: Enable feature flag
    feature_flags = ["Unified-Identity"]
    
    trust_bundle_path = "./.data/agent/spire/bootstrap.crt"
    trust_bundle_port = "8082"
    trust_domain = "example.org"
}

plugins {
    NodeAttestor "join_token" {
        plugin_data {
        }
    }
    
    WorkloadAttestor "unix" {
        plugin_data {
            discover_workload_path = true
        }
    }
    
    KeyManager "disk" {
        plugin_data {
            directory = "./.data/agent"
        }
    }
}
```

### 4.3 Verify Feature Flag in Code

The feature flag is defined in:
- **Location**: `spire/pkg/common/fflag/fflag.go`
- **Flag Name**: `Unified-Identity`
- **Default**: `false` (disabled)

## Step 5: Run SPIRE with Feature Flag Enabled

### 5.1 Initialize and Start SPIRE Server

```bash
cd ~/AegisEdgeAI/hybrid-cloud-poc/code-rollout-phase-1/spire

# Create data directory
mkdir -p .data/server

# Generate server bootstrap token
TOKEN=$(./spire-server token generate -spiffeID spiffe://example.org/myagent | awk '{print $2}')

# Start SPIRE Server
./spire-server run -config server.conf &
SERVER_PID=$!

# Wait for server to start
sleep 2

# Check server logs for feature flag
tail -20 spire-server.log | grep -i "unified-identity\|feature flag"
```

### 5.2 Start SPIRE Agent

```bash
# Create agent data directory
mkdir -p .data/agent

# Start SPIRE Agent (use token from above)
./spire-agent run -config agent.conf -joinToken $TOKEN &
AGENT_PID=$!

# Wait for agent to start
sleep 2

# Check agent logs for feature flag
tail -20 spire-agent.log | grep -i "unified-identity\|feature flag"
```

### 5.3 Verify Feature Flag is Active

Check logs for Unified Identity messages:

```bash
# Server logs
grep "Unified-Identity - Phase 1:" spire-server.log

# Agent logs
grep "Unified-Identity - Phase 1:" spire-agent.log
```

**Expected**: You should see log messages prefixed with `"Unified-Identity - Phase 1:"` indicating the feature is active.

## Step 6: Test Feature Flag Behavior

### 6.1 Test with Feature Flag Enabled

With feature flag enabled, sovereign attestation will be processed:

```bash
# Create a test workload entry
./spire-server entry create \
    -parentID spiffe://example.org/myagent \
    -spiffeID spiffe://example.org/workload \
    -selector unix:uid:$(id -u)

# Check server logs - should see sovereign attestation processing
tail -f spire-server.log | grep "Unified-Identity - Phase 1:"
```

### 6.2 Test with Feature Flag Disabled

Edit `server.conf` and `agent.conf` to remove or comment out the feature flag:

```hcl
# feature_flags = ["Unified-Identity"]  # Commented out
```

Restart services:

```bash
# Stop services
kill $SERVER_PID $AGENT_PID

# Restart with feature flag disabled
./spire-server run -config server.conf &
./spire-agent run -config agent.conf -joinToken $TOKEN &
```

**Expected**: No "Unified-Identity - Phase 1:" messages in logs. Sovereign attestation is ignored.

## Step 7: Run All Tests Together

### 7.1 Complete Test Suite

Run the comprehensive test script:

```bash
cd ~/AegisEdgeAI/hybrid-cloud-poc/code-rollout-phase-1
./test_all_sovereign.sh
```

**Expected Output**:
```
==========================================
Sovereign Attestation Test Suite
==========================================

Testing Keylime Client... PASSED
Testing Policy Engine... PASSED
Testing Server SVID Service (Sovereign)... PASSED
Testing Agent Workload Handler... PASSED

==========================================
Test Summary
==========================================
Passed: 4
Failed: 0

All tests passed!
```

### 7.2 Test Coverage Verification

Run all tests with coverage:

```bash
cd spire

# Generate coverage report
go test ./pkg/server/sovereign/... ./pkg/server/api/svid/v1/... ./pkg/agent/endpoints/workload/... -coverprofile=coverage.out

# View coverage
go tool cover -html=coverage.out -o coverage.html
```

## Step 8: Verify Logging

All Unified Identity logs are prefixed with `"Unified-Identity - Phase 1:"`.

### 8.1 Filter Logs

```bash
# View all Unified Identity logs from server
grep "Unified-Identity - Phase 1:" spire-server.log

# View all Unified Identity logs from agent
grep "Unified-Identity - Phase 1:" spire-agent.log

# View in real-time
tail -f spire-server.log | grep "Unified-Identity - Phase 1:"
```

### 8.2 Expected Log Messages

When feature flag is **enabled**:
- `"Unified-Identity - Phase 1: Processing sovereign attestation request (stubbed Keylime)"`
- `"Unified-Identity - Phase 1: Using stubbed Keylime Verifier (returning fixed claims)"`
- `"Unified-Identity - Phase 1: Evaluating policy for attested claims"`
- `"Unified-Identity - Phase 1: Policy evaluation passed"`

When feature flag is **disabled**:
- No Unified Identity log messages (feature is bypassed)

## API Usage

### Workload API (X509SVIDRequest)

Workloads can optionally include sovereign attestation:

```go
req := &workload.X509SVIDRequest{
    SovereignAttestation: &workload.SovereignAttestation{
        TpmSignedAttestation: "base64-encoded-tpm-quote",
        AppKeyPublic:         "pem-or-base64-public-key",
        AppKeyCertificate:    []byte("der-certificate"),
        ChallengeNonce:       "server-issued-nonce",
        WorkloadCodeHash:     "optional-code-hash",
    },
}
```

### Response (X509SVIDResponse)

Responses include attested claims when sovereign attestation is processed:

```go
resp := &workload.X509SVIDResponse{
    Svids: []*workload.X509SVID{...},
    AttestedClaims: []*workload.AttestedClaims{
        {
            Geolocation:        "Spain: N40.4168, W3.7038",
            HostIntegrityStatus: workload.AttestedClaims_PASSED_ALL_CHECKS,
            GpuMetricsHealth: &workload.AttestedClaims_GpuMetrics{
                Status:        "healthy",
                UtilizationPct: 15.0,
                MemoryMb:      10240,
            },
        },
    },
}
```

## Policy Configuration

Default policy (in `spire/pkg/server/sovereign/policy.go`):

```go
config := &sovereignpolicy.PolicyConfig{
    AllowedGeolocations:    []string{"Spain"},
    MinGPUUtilizationPct:   0.0,
    MinGPUMemoryMB:         0,
    RequireHealthyGPUStatus: false,
}
```

Customize by modifying the `SovereignPolicyConfig` in the SVID service configuration.

## Logging

All Unified Identity logs are prefixed with:
```
"Unified-Identity - Phase 1:"
```

Filter logs:
```bash
# View all Unified Identity logs
journalctl -u spire-server | grep "Unified-Identity - Phase 1:"

# Or in log files
grep "Unified-Identity - Phase 1:" /var/log/spire/server.log
```

## Troubleshooting

### Feature Not Working

1. **Check feature flag is enabled**:
   ```bash
   grep "feature_flags" server.conf agent.conf
   ```

2. **Check logs for feature flag status**:
   ```bash
   grep "Unified-Identity feature flag" logs/*.log
   ```

3. **Verify protobuf code is regenerated**:
   ```bash
   cd go-spiffe && make generate
   cd ../spire-api-sdk && make generate
   ```

### Build Errors

If you see errors about undefined types:
- `workload.SovereignAttestation`
- `workload.AttestedClaims`

**Solution**: Regenerate protobuf code (see BUILD_INSTRUCTIONS.md)

### Test Failures

If tests fail:
1. Ensure feature flag is loaded in test: `fflag.Load([]string{"Unified-Identity"})`
2. Check test cleanup: `defer fflag.Unload()`
3. Verify protobuf code is up to date

## Architecture

### Flow Diagram

```
Workload → Agent (Workload API)
    ↓
Agent generates/processes SovereignAttestation
    ↓
Agent → Server (Agent API with SovereignAttestation)
    ↓
Server → Keylime Verifier (stubbed in Phase 1)
    ↓
Server evaluates Policy
    ↓
Server → Agent (SVID with AttestedClaims)
    ↓
Agent → Workload (Response with AttestedClaims)
```

## Key Components

1. **Keylime Client** (`spire/pkg/server/sovereign/keylime/client.go`)
   - Stubbed implementation for Phase 1
   - Returns fixed hardcoded claims

2. **Policy Engine** (`spire/pkg/server/sovereign/policy.go`)
   - Evaluates attested claims
   - Configurable policies

3. **Server Integration** (`spire/pkg/server/api/svid/v1/service.go`)
   - Processes sovereign attestation
   - Calls Keylime and evaluates policy

4. **Agent Integration** (`spire/pkg/agent/endpoints/workload/`)
   - Handles sovereign attestation from workloads
   - Generates stubbed attestation when needed

## Next Steps

- **Phase 2**: Replace stubbed Keylime with full implementation
- **Phase 3**: Add TPM plugin and hardware integration
- **Phase 4**: Embed claims in SVID certificate extensions
- **Phase 5**: Add remediation actions

## Support

For issues or questions:
1. Check BUILD_INSTRUCTIONS.md for build issues
2. Check IMPLEMENTATION_SUMMARY.md for implementation details
3. Check COMPLETION_STATUS.md for current status
4. Review logs with "Unified-Identity - Phase 1:" prefix

---

**Version**: Phase 1  
**Status**: Complete and Ready for Testing  
**Feature Flag**: `Unified-Identity` (disabled by default)

