# Enterprise On-Prem Components (10.1.0.10)

This directory contains components for the enterprise on-prem environment that:
- Terminates mTLS from SPIRE clients (10.1.0.11)
- Verifies SPIRE certificate signatures
- Extracts mobile sensor ID from SPIRE certificates
- Calls mobile location service to verify sensor
- Forwards requests to backend mTLS server

## Architecture

```
SPIRE Client (10.1.0.11)
    |
    | mTLS (SPIRE cert)
    v
Envoy Proxy (10.1.0.10:8080)
    |
    | 1. Terminates mTLS
    | 2. Verifies SPIRE cert signature (using SPIRE CA bundle)
    | 3. Extracts sensor ID (via sensor-id-extractor service)
    | 4. Calls mobile location service
    | 5. Verifies response is "yes"
    |
    v
mTLS Server (10.1.0.10:9443)
```

## Components

### 1. Envoy Proxy (`envoy/`)
- **Port**: 8080 (listens for SPIRE client connections)
- **Function**: 
  - Terminates mTLS from SPIRE clients
  - Verifies SPIRE certificate signatures using SPIRE CA bundle
  - Uses Lua filter to extract sensor ID and verify with mobile location service
  - Forwards verified requests to backend mTLS server

### 2. Sensor ID Extractor (`sensor-id-extractor/`)
- **Port**: 5001
- **Function**: Extracts sensor ID from SPIRE certificate Unified Identity extension
- **API**: `POST /extract` with `{"cert_der_b64": "..."}` or `{"cert_pem": "..."}`

### 3. Mobile Location Service
- **Port**: 5000
- **Location**: `../mobile-sensor-microservice/`
- **Function**: Verifies sensor ID via CAMARA API
- **API**: `POST /verify` with `{"sensor_id": "12d1:1433"}`

### 4. mTLS Server
- **Port**: 9443
- **Location**: `../python-app-demo/mtls-server-app.py`
- **Function**: Backend server using standard certificates (no SPIRE)

## Setup

### Prerequisites

1. **Copy SPIRE CA bundle** from 10.1.0.11:
   ```bash
   # On 10.1.0.11 (where SPIRE Agent runs):
   cd ~/AegisEdgeAI/hybrid-cloud-poc/python-app-demo
   python3 fetch-spire-bundle.py
   
   # Copy to 10.1.0.10:
   scp /tmp/spire-bundle.pem mw@10.1.0.10:/tmp/spire-bundle.pem
   ```

2. **Copy server certificates** (if not already on 10.1.0.10):
   ```bash
   # On 10.1.0.10:
   mkdir -p ~/.mtls-demo
   # If server certs don't exist, they'll be auto-generated by mtls-server-app.py
   ```

### Installation

Run the setup script on 10.1.0.10:

```bash
cd ~/AegisEdgeAI/hybrid-cloud-poc/enterprise-onprem
./scripts/setup-onprem.sh
```

The script will:
1. Install dependencies (Python, Envoy, etc.)
2. Create necessary directories
3. Set up certificates (you'll need to copy them)
4. Install and configure services
5. Create systemd service files

### Manual Setup

If you prefer manual setup:

1. **Install Envoy**:
   ```bash
   curl -sL 'https://getenvoy.io/install.sh' | sudo bash -s -- -b /usr/local/bin
   ```

2. **Copy certificates**:
   ```bash
   sudo mkdir -p /opt/envoy/certs
   sudo cp /tmp/spire-bundle.pem /opt/envoy/certs/
   sudo cp ~/.mtls-demo/server-cert.pem /opt/envoy/certs/
   sudo cp ~/.mtls-demo/server-key.pem /opt/envoy/certs/
   ```

3. **Start mobile location service**:
   ```bash
   cd ~/AegisEdgeAI/hybrid-cloud-poc/mobile-sensor-microservice
   python3 -m venv .venv
   source .venv/bin/activate
   pip install -r requirements.txt
   python3 service.py --port 5000 --host 0.0.0.0 &
   ```

4. **Start sensor ID extractor**:
   ```bash
   cd ~/AegisEdgeAI/hybrid-cloud-poc/enterprise-onprem/sensor-id-extractor
   python3 -m venv .venv
   source .venv/bin/activate
   pip install flask cryptography
   python3 extract_sensor_id.py &
   ```

5. **Start mTLS server**:
   ```bash
   cd ~/AegisEdgeAI/hybrid-cloud-poc/python-app-demo
   export SERVER_USE_SPIRE="false"
   export SERVER_PORT="9443"
   export CA_CERT_PATH="/opt/envoy/certs/spire-bundle.pem"  # Optional: for strict client verification
   python3 mtls-server-app.py &
   ```

6. **Start Envoy**:
   ```bash
   sudo envoy -c ~/AegisEdgeAI/hybrid-cloud-poc/enterprise-onprem/envoy/envoy.yaml
   ```

## Testing

### From SPIRE Client (10.1.0.11)

```bash
cd ~/AegisEdgeAI/hybrid-cloud-poc/python-app-demo
export CLIENT_USE_SPIRE="true"
export SPIRE_AGENT_SOCKET="/tmp/spire-agent/public/api.sock"
export SERVER_HOST="10.1.0.10"  # Envoy on on-prem
export SERVER_PORT="8080"        # Envoy port
export CA_CERT_PATH="~/.mtls-demo/server-cert.pem"  # Server cert for verification
python3 mtls-client-app.py
```

### Verify Flow

1. **Check Envoy logs**:
   ```bash
   sudo journalctl -u envoy-proxy -f
   ```
   Should show: "Sensor verified successfully: 12d1:1433"

2. **Check mobile location service logs**:
   ```bash
   sudo journalctl -u mobile-sensor-service -f
   ```
   Should show verification requests and results

3. **Check mTLS server logs**:
   ```bash
   tail -f /tmp/mtls-server-app.log
   ```
   Should show connections from Envoy with `X-Sensor-ID` header

## Troubleshooting

### Envoy fails to start
- Check certificate paths in `/opt/envoy/certs/`
- Verify Envoy config: `envoy --config-path envoy.yaml --mode validate`

### Sensor ID extraction fails
- Check sensor-id-extractor service is running: `curl http://localhost:5001/health`
- Verify SPIRE cert has Unified Identity extension with geolocation data

### Mobile location service fails
- Check service is running: `curl http://localhost:5000/verify -X POST -H "Content-Type: application/json" -d '{}'`
- Verify sensor ID exists in database: Check `mobile-sensor-microservice/sensor_mapping.db`

### Certificate verification fails
- Ensure SPIRE CA bundle is correct: `/opt/envoy/certs/spire-bundle.pem`
- Verify client cert is signed by SPIRE CA in bundle

## Files

- `envoy/envoy.yaml` - Envoy proxy configuration
- `sensor-id-extractor/extract_sensor_id.py` - Sensor ID extraction service
- `scripts/setup-onprem.sh` - Automated setup script

