# Fixes Needed for Single Machine Setup

## Current Status

### ✅ What's Working
1. TPM Plugin Server is running and responding correctly
2. `test_complete.sh` already sets `TPM_PLUGIN_CLI_PATH` at line 21
3. `test_complete.sh` already sets `USE_TPM2_QUOTE_DIRECT=0` at line 1622 (correct setting)
4. Keylime Verifier config has mTLS settings in `/etc/keylime/verifier.conf`
5. When you manually start SPIRE Agent with `TPM_PLUGIN_CLI_PATH` set, it connects to TPM Plugin successfully

### ❌ What's NOT Working
1. **SPIRE Agent Workload API socket not created** (`/tmp/spire-agent/public/api.sock` missing)
   - Agent crashes with: `rpc error: code = InvalidArgument desc = nodeattestor(join_token): join token was not provided`
   - This happens because agent is NOT using the `unified_identity` node attestor

2. **rust-keylime agent crashes** when trying to parse App Key from TPM Plugin
   - Error: `Failed to parse PEM public key: error:1E08010C:DECODER routines`
   - This is a format mismatch between TPM Plugin output and rust-keylime expectations

## Root Cause Analysis

### Issue 1: SPIRE Agent Not Using unified_identity Attestor

The SPIRE Agent is trying to use `join_token` attestor instead of `unified_identity`. This means:
- The agent config file (`python-app-demo/spire-agent.conf`) might not have the correct node attestor configured
- OR the `UNIFIED_IDENTITY_ENABLED` environment variable is not being passed correctly

**Check this:**
```bash
cat ~/dhanush/hybrid-cloud-poc-backup/python-app-demo/spire-agent.conf | grep -A10 "NodeAttestor"
```

The config should have:
```
NodeAttestor "unified_identity" {
    plugin_cmd = "/path/to/tpm_plugin_cli.py"
    plugin_data {
        tpm_plugin_endpoint = "unix:///tmp/spire-data/tpm-plugin/tpm-plugin.sock"
    }
}
```

### Issue 2: rust-keylime Agent PEM Format Mismatch

The TPM Plugin returns an App Key in PEM format, but rust-keylime cannot parse it. This could be:
- The PEM format has extra newlines or formatting issues
- The key type is not what rust-keylime expects
- OpenSSL version mismatch

## Fixes to Apply

### Fix 1: Verify SPIRE Agent Config

**Action:** Check if `python-app-demo/spire-agent.conf` has the correct unified_identity node attestor configuration.

Run this command on your remote machine:
```bash
cat ~/dhanush/hybrid-cloud-poc-backup/python-app-demo/spire-agent.conf
```

If it doesn't have the `unified_identity` node attestor, you need to add it or regenerate the config.

### Fix 2: Check Where spire-agent.conf is Generated

The config file is likely generated by one of the test scripts. Let's find where:

**Search in test_complete_control_plane.sh** - this script likely generates the SPIRE Server and Agent configs.

### Fix 3: Ensure TPM_PLUGIN_CLI_PATH is in Environment

Even though `test_complete.sh` exports `TPM_PLUGIN_CLI_PATH` at line 21, when using `setsid nohup`, the environment might not be passed correctly.

**Recommended fix:** Explicitly pass `TPM_PLUGIN_CLI_PATH` when starting SPIRE Agent.

Change line 2290 in `test_complete.sh` from:
```bash
setsid nohup "${SPIRE_AGENT}" run -config "${AGENT_CONFIG}" > /tmp/spire-agent.log 2>&1 &
```

To:
```bash
setsid nohup env TPM_PLUGIN_CLI_PATH="${TPM_PLUGIN_CLI_PATH}" TPM_PLUGIN_ENDPOINT="${TPM_PLUGIN_ENDPOINT}" UNIFIED_IDENTITY_ENABLED="${UNIFIED_IDENTITY_ENABLED}" "${SPIRE_AGENT}" run -config "${AGENT_CONFIG}" > /tmp/spire-agent.log 2>&1 &
```

## Next Steps

### Step 1: Check SPIRE Agent Config
```bash
cd ~/dhanush/hybrid-cloud-poc-backup
cat python-app-demo/spire-agent.conf
```

**Send me the output** so I can verify if the unified_identity node attestor is configured correctly.

### Step 2: Find Where Config is Generated

If the config is wrong, we need to find where it's generated and fix it there.

```bash
cd ~/dhanush/hybrid-cloud-poc-backup
grep -n "spire-agent.conf" test_complete_control_plane.sh | head -20
```

### Step 3: Check rust-keylime Agent Logs

The PEM parsing error might give us more clues:
```bash
tail -100 /tmp/rust-keylime-agent.log | grep -A5 -B5 "Failed to parse PEM"
```

## Important Notes

1. **NO REBOOT NEEDED** - This is a configuration issue, not a system state issue
2. The `test_complete.sh` script already has most of the correct settings
3. The main issue is likely in the SPIRE Agent config file or how environment variables are passed
4. Once we fix the SPIRE Agent config, the Workload API socket should be created
5. The rust-keylime PEM parsing issue might be a separate problem that needs investigation

## What to Send Me

Please run these commands and send me the output:

```bash
# 1. Check SPIRE Agent config
cat ~/dhanush/hybrid-cloud-poc-backup/python-app-demo/spire-agent.conf

# 2. Check where config is generated
grep -n "spire-agent.conf" ~/dhanush/hybrid-cloud-poc-backup/test_complete_control_plane.sh | head -20

# 3. Check rust-keylime logs for PEM error
tail -100 /tmp/rust-keylime-agent.log | grep -A5 -B5 "Failed to parse PEM"

# 4. Check if TPM_PLUGIN_CLI_PATH exists
ls -la ~/dhanush/hybrid-cloud-poc-backup/tpm-plugin/tpm_plugin_cli.py
```

Once I see these outputs, I can provide the exact fixes needed.
