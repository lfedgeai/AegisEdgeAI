name: Unified Identity CI

on:
    push:
        branches: ["main", "develop", "feat/**"] # Triggers on any branch starting with feat/
    pull_request:
        branches: ["main", "develop"]
    workflow_dispatch: # This allows manual testing on ANY branch

jobs:
    integration-test:
        name: Hybrid Cloud PoC Integration Test
        runs-on: self-hosted

        steps:
            - name: Checkout Code
              uses: actions/checkout@v4
              with:
                  submodules: recursive

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.10"

            - name: Install Dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -r hybrid-cloud-poc/keylime/requirements.txt

            - name: Run Integration Tests
              shell: bash
              run: |
                  cd hybrid-cloud-poc
                  chmod +x ci_test_runner.py test_integration.sh
                  # --no-color ensures clean logs in GitHub Actions
                  # Explicitly targeting 10.1.0.10 (mwserver12)
                  ./ci_test_runner.py --no-color -- --control-plane-host 10.1.0.10 --agents-host 10.1.0.10 --onprem-host 10.1.0.10
